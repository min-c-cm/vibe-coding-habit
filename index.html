<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HabitDuo - 雲端治癒習慣追蹤</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-brand': '#A78BFA',
                        'primary-inverse': '#FFFFFF',
                        'nav-bg': '#9d80f3',
                        'success-mint': '#6EE7B7',
                        'streak-coral': '#FDA4AF',
                        'accent-purple': '#4C1D95',
                        'gold-shine': '#FBBF24',
                        'progress-track': '#B4C0FF',
                        'progress-fill': '#6366F1',
                    },
                    backgroundImage: {
                        'ethereal-gradient': 'linear-gradient(to bottom, #C4B5FD, #A5B4FC, #E0E7FF)',
                        'rainbow-energy': 'linear-gradient(90deg, #6EE7B7, #60A5FA, #A78BFA, #6EE7B7)',
                    },
                    borderRadius: {
                        'habit': '16px',
                    },
                    boxShadow: {
                        'dreamy': '0 10px 40px -10px rgba(167, 139, 250, 0.4)',
                        'nav-dock': '0 -10px 40px rgba(76, 29, 149, 0.15)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'PingFang TC', 'Inter', sans-serif;
            background: linear-gradient(to bottom, #C4B5FD, #A5B4FC, #E0E7FF) !important;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
        }

        .dreamy-bg-fixed {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .cloud-glow-1 {
            position: absolute;
            width: 300px; height: 300px;
            top: -50px; left: -50px;
            background: #A78BFA;
            filter: blur(90px);
            opacity: 0.5;
            border-radius: 50%;
        }

        .cloud-glow-2 {
            position: absolute;
            width: 400px; height: 400px;
            bottom: -50px; right: -50px;
            background: #6366F1;
            filter: blur(110px);
            opacity: 0.4;
            border-radius: 50%;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.72) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            border-radius: 16px !important;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-12px); }
        }
        .animate-float { animation: float 4s ease-in-out infinite; }

        .custom-scroll {
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .custom-scroll::-webkit-scrollbar { display: none; }

        .week-grid, .month-grid {
            display: grid;
            gap: 6px;
        }
        .week-grid { grid-template-columns: repeat(7, 1fr); }
        .month-grid { grid-template-columns: repeat(7, 1fr); }
        
        .swipe-item-container {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            background-color: #FDA4AF;
        }
        .swipe-content {
            position: relative;
            z-index: 10;
            background-color: white;
            transition: transform 0.3s ease;
        }

        @keyframes confetti-pop {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) scale(0); opacity: 0; }
        }
        .confetti-particle {
            position: fixed;
            z-index: 200;
            pointer-events: none;
            animation: confetti-pop 1.5s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="max-w-md mx-auto relative overflow-hidden text-left">

<!-- 物理漸層背景層 -->
<div class="dreamy-bg-fixed">
    <div class="cloud-glow-1"></div>
    <div class="cloud-glow-2"></div>
</div>

<div id="app" class="flex flex-col h-dvh overflow-hidden relative z-10">
    
    <!-- 打卡拉炮特效粒子 -->
    <div v-for="c in confettiList" :key="c.id" 
         class="confetti-particle"
         :style="{ 
            left: c.originX + 'px', 
            top: c.originY + 'px', 
            backgroundColor: c.color, 
            width: c.size + 'px', 
            height: c.size + 'px', 
            '--tw-translate-x': c.tx + 'px', 
            '--tw-translate-y': c.ty + 'px', 
            '--tw-rotate': c.rot + 'deg' 
         }">
    </div>

    <!-- 頂部導覽列 (Radius 0,0,16,16) -->
    <header class="bg-white/50 backdrop-blur-xl rounded-b-[16px] border-b border-white/30 z-50 flex-shrink-0 relative">
        <template v-if="activeTab === 'home'">
            <div class="px-6 pt-4 pb-2 flex items-center justify-between">
                <div @click="toggleCalendarView" class="flex items-center gap-2 cursor-pointer active:scale-95 transition-transform group text-left">
                    <span class="font-black text-accent-purple text-xl tracking-tight">{{ statsMonthLabel }}</span>
                    <i :data-lucide="isHistoryMonthView ? 'chevron-up' : 'chevron-down'" class="w-5 h-5 text-accent-purple/30 text-center"></i>
                </div>
                <div v-if="!isHistoryMonthView" class="flex items-center gap-2">
                    <span class="text-[10px] font-black text-accent-purple/30 uppercase">Progress</span>
                    <div class="px-2.5 py-0.5 rounded-full bg-primary-brand/10 border border-primary-brand/20 text-[10px] font-black text-primary-brand">
                        {{ dayDoneCount }} / {{ habitsForSelectedDay.length }}
                    </div>
                </div>
            </div>
            <!-- 週曆 -->
            <div v-if="!isHistoryMonthView" class="px-4 pb-4 animate-slide-up text-center">
                <div class="flex items-center gap-1">
                    <button @click.stop="changeWeek(-1)" class="w-8 h-8 flex items-center justify-center text-primary-brand active:scale-75 text-center"><i data-lucide="chevron-left" class="w-5 h-5 text-center"></i></button>
                    <div class="flex-1 week-grid">
                        <div v-for="day in weekDays" :key="day.date" @click.stop="selectedDate = day.date"
                             :class="['flex flex-col items-center py-2 rounded-[14px] transition-all cursor-pointer border text-center relative', isSameDay(selectedDate, day.date) ? 'bg-primary-brand border-primary-brand text-white shadow-lg scale-105' : 'bg-white/30 border-transparent text-accent-purple/40']">
                            <span class="text-[8px] font-black uppercase mb-0.5">{{ day.label }}</span>
                            <span class="text-sm font-black">{{ day.dayNum }}</span>
                            <div v-if="hasLog(day.date)" class="absolute -top-1 -right-1 rounded-full p-0.5 border border-white bg-success-mint text-white flex items-center justify-center"><i data-lucide="check" class="w-2 h-2 text-center"></i></div>
                        </div>
                    </div>
                    <button @click.stop="changeWeek(1)" class="w-8 h-8 flex items-center justify-center text-primary-brand active:scale-75 text-center"><i data-lucide="chevron-right" class="w-5 h-5 text-center"></i></button>
                </div>
            </div>
            <!-- 月曆 -->
            <div v-if="isHistoryMonthView" class="px-6 pb-6 animate-slide-up text-center">
                <div class="flex items-center justify-between mb-4">
                    <button @click="changeMonth(-1)" class="p-2 text-primary-brand active:scale-75 text-center"><i data-lucide="arrow-left" class="w-5 h-5 text-center"></i></button>
                    <span class="font-black text-accent-purple/20 text-[10px] uppercase tracking-widest text-center">History</span>
                    <button @click="changeMonth(1)" class="p-2 text-primary-brand active:scale-75 text-center"><i data-lucide="arrow-right" class="w-5 h-5 text-center"></i></button>
                </div>
                <div class="month-grid text-center">
                    <div v-for="dayLabel in weekLabelsShort" :key="dayLabel" class="text-center text-[10px] font-black text-accent-purple/20 uppercase mb-2 text-center">{{ dayLabel }}</div>
                    <div v-for="(day, idx) in calendarDays" :key="idx" 
                         @click="selectedDate = day.date; isHistoryMonthView = false"
                         :class="['relative aspect-square flex items-center justify-center rounded-xl text-sm font-black transition-all cursor-pointer border', 
                                  !day.currentMonth ? 'opacity-10 border-transparent' : 
                                  isSameDay(selectedDate, day.date) ? 'bg-primary-brand text-white border-primary-brand shadow-lg scale-105' : 'bg-white/40 border-white/20 text-accent-purple']">
                        {{ day.date.getDate() }}
                        <div v-if="hasLog(day.date)" class="absolute bottom-1 w-1.5 h-1.5 rounded-full bg-success-mint text-center text-center"></div>
                    </div>
                </div>
            </div>
        </template>
        <template v-else>
            <div class="px-6 py-5 flex justify-center items-center relative text-left">
                <h2 class="text-xl font-black text-accent-purple tracking-tight text-center">{{ activeTab === 'habits' ? '我的習慣列表' : tabTitlesShort[activeTab] }}</h2>
                <button v-if="activeTab === 'habits' && habits.length > 0" @click="openHabitModal()" 
                        class="absolute right-5 w-10 h-10 rounded-full bg-primary-brand text-white flex items-center justify-center shadow-lg active:scale-90 transition-transform text-center text-center text-center">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>
            </div>
        </template>
    </header>

    <!-- 主內容區 -->
    <main class="flex-1 flex flex-col overflow-hidden min-h-0 text-left">
        
        <!-- 0. 首頁養成分頁 (1.6 : 1) -->
        <section v-if="activeTab === 'home'" class="animate-slide-up h-full flex flex-col overflow-hidden min-h-0 text-left">
            <!-- 寵物區 (Hero Section 權重 1.6) -->
            <div class="flex-[1.6] flex flex-col items-center justify-center relative px-6 py-2 min-h-0 text-center">
                <!-- 對話泡泡 -->
                <div class="absolute top-6 left-1/2 ml-4 bg-white p-4 rounded-[22px] rounded-bl-none shadow-dreamy z-20 max-w-[170px] text-center border-none">
                    <p class="text-[13px] font-bold text-accent-purple leading-snug">{{ mascotGreeting }}</p>
                    <div class="absolute -bottom-1.5 left-0 w-4 h-4 bg-white transform -rotate-45 text-center"></div>
                </div>

                <!-- 寵物蛋角色 -->
                <div :class="['w-40 h-40 flex items-center justify-center relative z-10 animate-float transition-all duration-500 mb-6', isAnimating ? 'brightness-125 scale-105' : '']">
                    <img v-if="birdLevel === 0" src="https://raw.githubusercontent.com/min-c-cm/vibe-coding-habit/main/egg.svg" alt="Pet Egg" class="w-24 h-24 object-contain drop-shadow-2xl mx-auto">
                    <svg v-else viewBox="0 0 100 100" class="w-32 h-32 drop-shadow-2xl mx-auto">
                        <defs><radialGradient id="gradPet" cx="40%" cy="30%" r="60%"><stop offset="0%" style="stop-color:#C4B5FD" /><stop offset="100%" style="stop-color:#A78BFA" /></radialGradient></defs>
                        <circle cx="50" cy="50" r="46" fill="url(#gradPet)" />
                        <circle cx="32" cy="40" r="8" fill="white" /><circle cx="68" cy="40" r="8" fill="white" />
                        <circle cx="34" cy="38" r="3" fill="#4C1D95" opacity="0.8" /><circle cx="70" cy="38" r="3" fill="#4C1D95" opacity="0.8" />
                        <path d="M45 52 L55 52 L50 64 Z" fill="#FBBF24" />
                        <path v-if="birdLevel > 1" d="M40 72 Q50 82 60 72" stroke="white" stroke-width="4" fill="none" stroke-linecap="round" />
                    </svg>
                </div>

                <!-- 進度條與等級 -->
                <div class="w-full max-w-[310px] h-12 bg-progress-track rounded-full relative p-1 flex items-center shadow-inner mt-2 overflow-visible mx-auto text-center">
                    <div class="absolute left-1 top-1 bottom-1 rounded-full bg-progress-fill transition-all duration-1000 shadow-md flex items-center overflow-hidden"
                         :style="{ width: 'calc(' + Math.min((totalCheckinCount / (evolutionRequirement || 10)) * 100, 100) + '% - 4px)' }">
                         <span class="ml-5 text-white font-extrabold text-sm whitespace-nowrap uppercase italic drop-shadow-md text-center">Lv.{{ birdLevel + 1 }}</span>
                    </div>
                    <div class="relative w-full h-full flex items-center justify-end px-12 z-10 pointer-events-none text-white text-center">
                        <div class="flex items-center gap-2 text-center text-center">
                            <span class="font-black text-[15px] drop-shadow-lg text-center">{{ totalCheckinCount }} / {{ evolutionRequirement }}</span>
                            <i data-lucide="zap" class="w-4 h-4 text-gold-shine fill-gold-shine text-center"></i>
                        </div>
                    </div>
                    <div class="absolute right-0.5 w-11 h-11 bg-white rounded-full flex items-center justify-center shadow-md active:scale-125 hover:scale-110 transition-all z-20 border border-purple-50 cursor-pointer">
                        <svg viewBox="0 0 100 100" class="w-6 h-6 fill-progress-fill text-center">
                            <path d="M50 15 C35 15 20 35 20 60 C20 80 35 90 50 90 C65 90 80 80 80 60 C80 35 65 15 50 15 Z" />
                            <path d="M35 50 L45 60 L55 50 L65 60" fill="none" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- 今日目標區 (16px) -->
            <div class="flex-1 px-5 pb-5 overflow-hidden flex flex-col min-h-0 text-left text-left text-left">
                <div class="glass-card flex flex-col h-full overflow-hidden text-left">
                    <div class="flex-1 custom-scroll p-5 space-y-4">
                        <h3 class="font-black text-accent-purple text-sm mb-1 px-1 opacity-80 flex items-center gap-2 text-left text-left text-left">
                            <i data-lucide="target" class="w-4 h-4 text-primary-brand text-center text-center text-center"></i>
                            今日目標
                        </h3>

                        <div v-if="habitsForSelectedDay.length > 0" class="space-y-3 pb-8 text-left text-left text-left text-left">
                            <div v-for="habit in habitsForSelectedDay" :key="habit.id" 
                                 class="flex items-center justify-between p-4 rounded-[16px] bg-white/80 border border-white shadow-sm transition-all active:scale-[0.97] text-left">
                                <div class="flex items-center gap-4 min-w-0 flex-1 text-left">
                                    <div :class="['w-11 h-11 rounded-[14px] flex-shrink-0 flex items-center justify-center text-white shadow-sm transition-all text-center text-center', isChecked(habit.id) ? 'bg-success-mint scale-90' : habit.color]"><i :data-lucide="habit.icon" class="w-6 h-6 text-center text-center text-center"></i></div>
                                    <div class="min-w-0 flex-1 text-left text-left text-left">
                                        <span :class="['font-black text-[16px] text-accent-purple block truncate text-left', isChecked(habit.id) ? 'opacity-30 line-through text-left' : 'text-left']">{{ habit.name }}</span>
                                        <span v-if="isChecked(habit.id) && getMood(habit.id)" class="text-[11px] text-accent-purple/30 italic block truncate mt-0.5 leading-none text-left">「 {{ getMood(habit.id) }} 」</span>
                                    </div>
                                </div>
                                <button @click.stop="handleCheckinFeedback(habit, $event)" 
                                        :class="['w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center transition-all shadow-sm border text-center text-center text-center', isChecked(habit.id) ? 'bg-success-mint border-success-mint text-white shadow-lg' : 'bg-white border-gray-100 text-gray-200']">
                                    <i data-lucide="check" class="w-6 h-6 text-center"></i>
                                </button>
                            </div>
                            <button @click.stop="openHabitModal()" class="w-full h-12 border-2 border-dashed border-primary-brand/30 rounded-[16px] flex items-center justify-center gap-2 text-primary-brand/70 font-black hover:bg-primary-brand/10 active:scale-95 transition-all mt-2 text-center text-center">
                                <i data-lucide="plus-circle" class="w-5 h-5 text-center text-center"></i>
                                <span class="text-sm text-center">新增今日目標</span>
                            </button>
                        </div>

                        <!-- 空狀態與 48px 引導按鈕 -->
                        <div v-else class="h-full flex flex-col items-center justify-center py-6 text-center text-center text-center">
                            <div class="opacity-20 flex flex-col items-center mb-6">
                                <i data-lucide="sparkles" class="w-12 h-12 mb-3 text-accent-purple mx-auto text-center text-center text-center"></i>
                                <p class="text-base font-black italic text-center">此日無計畫</p>
                            </div>
                            <button @click.stop="openHabitModal()" class="w-full h-[48px] border-2 border-dashed border-primary-brand/40 rounded-[16px] bg-white/30 hover:bg-white/50 flex items-center justify-center gap-2 text-primary-brand font-black active:scale-[0.98] transition-all group text-center text-center text-center text-center">
                                <i data-lucide="plus" class="w-5 h-5 group-hover:scale-110 transition-transform text-center text-center text-center"></i>
                                <span class="text-base text-center">開始建立第一個習慣吧！</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 1. 我的習慣清單頁 -->
        <section v-if="activeTab === 'habits'" class="animate-slide-up h-full flex flex-col px-5 py-5 overflow-hidden text-left">
            <div v-if="habits.length === 0" class="flex-1 flex flex-col items-center justify-center text-center animate-slide-up text-center text-center">
                <div class="w-32 h-32 bg-white/30 rounded-full flex items-center justify-center mb-8 shadow-inner border border-white/20 mx-auto text-center">
                    <i data-lucide="clipboard-list" class="w-16 h-16 text-primary-brand opacity-40 text-center text-center"></i>
                </div>
                <h3 class="text-2xl font-black text-accent-purple mb-3 text-center text-center">還沒有建立習慣嗎？</h3>
                <p class="text-accent-purple/40 font-bold mb-10 max-w-[240px] mx-auto text-center">從一個小小的目標開始，開啟您的治癒養成之旅。</p>
                <button @click="openHabitModal()" 
                        class="px-10 h-16 bg-primary-brand rounded-[20px] text-white font-black text-xl shadow-dreamy active:scale-95 transition-all flex items-center gap-3 mx-auto">
                    <i data-lucide="plus" class="w-6 h-6 text-center"></i>
                    新增目標
                </button>
            </div>
            <div v-else class="flex-1 custom-scroll space-y-4 pb-24 text-left">
                <transition-group name="list" tag="div" class="space-y-4 text-left text-left text-left">
                    <div v-for="habit in sortedHabits" :key="habit.id" class="swipe-item-container shadow-dreamy text-left" :class="habit.isActive === false ? 'opacity-60 grayscale-[50%]' : ''">
                        <div class="swipe-content glass-card p-6 flex flex-col gap-6 text-left" :style="{ transform: swipedId === habit.id ? 'translateX(-80px)' : 'translateX(0)' }" @touchstart="handleTouchStart($event, habit.id)" @touchend="handleTouchEnd($event, habit.id)">
                            <div class="flex justify-between items-start text-left text-left">
                                <div class="flex items-center gap-4 min-w-0 flex-1 text-left text-left">
                                    <div :class="['w-14 h-14 rounded-[16px] flex-shrink-0 flex items-center justify-center text-white shadow-sm text-center text-center', habit.color]"><i :data-lucide="habit.icon" class="w-8 h-8 text-center text-center"></i></div>
                                    <div class="min-w-0 flex-1 text-left text-left">
                                        <h3 class="font-black text-xl text-accent-purple truncate text-left">{{ habit.name }}</h3>
                                        <p class="text-xs text-accent-purple/40 font-bold mt-1 text-left">每週: {{ habit.selectedDays.map(d => weekLabelsShort[d]).join(', ') }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4 text-center">
                                    <div @click.stop="toggleHabitActive(habit)" class="switch-track text-center" :class="habit.isActive !== false ? 'bg-success-mint' : 'bg-gray-200'"><div class="switch-thumb text-center" :class="habit.isActive !== false ? 'translate-x-5' : 'left-0.5 text-center'"></div></div>
                                    <button @click.stop="openHabitModal(habit)" class="w-10 h-10 bg-gray-50 rounded-[16px] flex items-center justify-center text-primary-brand active:scale-90 transition-all text-center text-center"><i data-lucide="edit-3" class="w-6 h-6 text-center text-center"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="absolute right-0 top-0 bottom-0 w-20 flex items-center justify-center text-white cursor-pointer text-center text-center text-center" @click="deleteHabit(habit.id)"><i data-lucide="trash-2" class="w-7 h-7 mx-auto text-center"></i></div>
                    </div>
                </transition-group>
            </div>
        </section>

        <!-- 2. 統計數據頁 (圖表回歸) -->
        <section v-if="activeTab === 'stats'" class="animate-slide-up h-full flex flex-col px-5 py-5 overflow-hidden text-left text-left text-left text-left">
            <div class="flex-1 custom-scroll space-y-6 pb-24 text-left">
                <div class="grid grid-cols-4 gap-2.5 text-center text-center text-center text-center text-center text-center text-center">
                    <div v-for="stat in topStats" :key="stat.label" class="glass-card p-4 flex flex-col items-center justify-center space-y-1 text-center text-center text-center text-center text-center">
                        <span class="text-[9px] font-black text-accent-purple/40 uppercase tracking-tighter text-center">{{ stat.label }}</span>
                        <span class="text-xl font-black text-accent-purple text-center">{{ stat.value }}</span>
                    </div>
                </div>

                <!-- 週分析圖表 -->
                <div class="glass-card p-6 space-y-6 text-left">
                    <div class="flex flex-col gap-5 text-left text-left">
                        <div class="flex justify-between items-start text-left text-left">
                            <h3 class="text-lg font-black text-accent-purple">週趨勢分析</h3>
                            <div class="px-2.5 py-1 rounded-full bg-success-mint/10 border border-success-mint/20 text-[9px] font-black text-success-mint text-center text-center">達成率 %</div>
                        </div>
                        <div class="flex p-1 bg-primary-brand/5 rounded-full border border-primary-brand/10 text-center text-center">
                            <button v-for="filter in [{id:'all',label:'所有'},{id:'seven',label:'近七週'},{id:'month',label:'近一月'}]" 
                            :key="filter.id" @click="statsFilter = filter.id"
                            :class="['flex-1 py-2 text-[11px] font-black rounded-full transition-all text-center', statsFilter === filter.id ? 'bg-primary-brand text-white shadow-sm text-center' : 'text-accent-purple/40 text-center']">
                                {{ filter.label }}
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto no-scrollbar pb-2 text-center text-center">
                        <div class="flex items-end justify-start gap-4 min-w-full px-2 h-44 text-center">
                            <div v-for="(w, idx) in filteredWeeklyData" :key="idx" class="flex flex-col items-center gap-3 w-8 flex-shrink-0 text-center text-center">
                                <div class="w-full bg-primary-brand/10 rounded-full relative overflow-hidden flex flex-col justify-end text-center" style="height: 140px;">
                                    <div class="w-full bg-primary-brand transition-all duration-1000 rounded-t-full shadow-lg text-center" :style="{ height: w.rate + '%' }">
                                         <div class="w-full h-full bg-gradient-to-t from-transparent to-white/30 opacity-40 text-center"></div>
                                    </div>
                                </div>
                                <span class="text-[9px] font-black text-accent-purple/30 whitespace-nowrap text-center">{{ w.label }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 月排行 -->
                <div class="glass-card p-6 space-y-5 text-left text-left text-left">
                    <h3 class="text-lg font-black text-accent-purple">本月排行</h3>
                    <div class="space-y-3">
                        <div v-for="(item, index) in monthlyRanking" :key="item.id" class="flex items-center justify-between p-4 rounded-[16px] bg-white/40 border border-white/40 shadow-sm text-left">
                            <div class="flex items-center gap-4 text-left">
                                <div class="w-6 h-6 flex items-center justify-center rounded-full bg-accent-purple text-white text-[10px] font-black text-center text-center">{{ index + 1 }}</div>
                                <div :class="['w-10 h-10 rounded-xl flex items-center justify-center text-white text-center text-center', item.color]"><i :data-lucide="item.icon" class="w-6 h-6 text-center text-center"></i></div>
                                <span class="font-black text-accent-purple text-base text-left">{{ item.name }}</span>
                            </div>
                            <div class="flex items-baseline gap-1 text-center text-center"><span class="text-lg font-black text-primary-brand">{{ item.count }}</span><span class="text-[10px] font-black text-accent-purple/30">次</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 底部導覽列 -->
    <nav class="h-[84px] glass-surface flex items-center shadow-nav-dock flex-shrink-0 z-50 text-left text-left text-left">
        <div class="w-full flex justify-around items-center px-6 relative text-center text-center text-center text-center text-center">
            <button v-for="tab in ['home', 'habits', 'stats']" :key="tab" @click="activeTab = tab; isHistoryMonthView = false" 
                    :class="['flex flex-col items-center justify-center gap-1.5 transition-all flex-1 py-3 text-center text-center text-center text-center text-center', activeTab === tab ? 'text-accent-purple scale-110 font-black' : 'text-white/70']">
                <i :data-lucide="tabIcons[tab]" class="w-6.5 h-6.5 text-center text-center text-center text-center"></i>
                <span class="text-[12px] uppercase font-black tracking-wider text-center text-center text-center">{{ tab === 'habits' ? '清單' : tabTitlesShort[tab] }}</span>
            </button>
        </div>
    </nav>

    <!-- 打卡心情日記彈窗 -->
    <div v-if="logModal.show" class="fixed inset-0 bg-black/40 backdrop-blur-md z-[130] flex items-center justify-center p-6 text-left text-left" @click.self="logModal.show = false">
        <div class="bg-white w-full max-sm rounded-[24px] p-8 space-y-8 shadow-2xl animate-slide-up relative text-center">
            <button @click.stop="logModal.show = false" class="absolute top-6 right-6 text-gray-300 hover:text-accent-purple transition-colors text-center text-center"><i data-lucide="x" class="w-7 h-7 text-center text-center text-center"></i></button>
            <div class="flex flex-col items-center gap-4 text-center">
                <div :class="['w-20 h-20 rounded-[20px] flex items-center justify-center text-white shadow-lg shadow-dreamy text-center text-center text-center', logModal.habit?.color]"><i :data-lucide="logModal.habit?.icon || 'check'" class="w-10 h-10 text-center text-center"></i></div>
                <h3 class="text-[28px] font-black text-accent-purple tracking-tight text-center">打卡成功！</h3>
            </div>
            <textarea v-model="logModal.note" rows="3" placeholder="紀錄此刻心情..." class="w-full p-5 bg-gray-50 rounded-[16px] text-accent-purple font-bold text-sm outline-none resize-none shadow-inner text-left text-left"></textarea>
            <button @click.stop="saveCheckinLog" class="w-full h-14 bg-primary-brand rounded-[16px] font-black text-white text-lg shadow-dreamy active:scale-95 transition-all text-center">儲存心得</button>
        </div>
    </div>

    <!-- 新增習慣彈窗 -->
    <div v-if="habitModal.show" class="fixed inset-0 bg-black/40 backdrop-blur-lg z-[120] flex items-end sm:items-center justify-center p-0 sm:p-6 text-left text-left text-left" @click.self="habitModal.show = false">
        <div class="bg-white w-full max-w-md rounded-t-[24px] sm:rounded-[24px] flex flex-col h-[90vh] shadow-2xl animate-slide-up relative text-left">
            <div class="flex-1 custom-scroll p-8 space-y-8 overflow-y-auto text-left text-left text-left">
                <h3 class="text-2xl font-black text-accent-purple tracking-tight text-center text-center">開始新的挑戰</h3>
                <div class="space-y-8 pb-10 text-left">
                    <div class="space-y-4 text-left">
                        <div class="flex justify-between items-center px-1 text-left"><label class="text-sm font-black text-accent-purple/60 uppercase">習慣名稱</label><span v-if="habitErrors.name" class="text-xs font-bold text-streak-coral animate-pulse text-center text-center">必填內容</span></div>
                        <input v-model="habitModal.data.name" type="text" placeholder="你想養成的習慣..." class="w-full duo-input px-6 h-14 text-lg font-black border-gray-100 focus:border-primary-brand text-left text-left text-left" @input="handleSmartHint">
                        <div class="flex gap-2 overflow-x-auto py-2 snap-x scroll-smooth no-scrollbar text-left text-left text-left"><button v-for="suggest in suggestionHabits" :key="suggest" @click.stop="selectSuggestion(suggest)" class="px-5 py-2.5 rounded-full text-xs font-black text-accent-purple/60 bg-gray-50 border border-transparent hover:border-primary-brand/30 hover:bg-white active:scale-95 snap-start whitespace-nowrap text-center text-center">{{ suggest }}</button></div>
                    </div>
                    <div class="space-y-4 text-left text-left">
                        <label class="text-sm font-black text-accent-purple/60 uppercase px-1 text-left text-left">主題風格</label>
                        <div class="grid grid-cols-5 gap-4 text-center">
                            <div v-for="theme in themeLibrary" :key="theme.id" @click.stop="applyTheme(theme)" :class="['flex-shrink-0 rounded-2xl flex items-center justify-center text-white transition-all cursor-pointer aspect-square text-center', theme.color, habitModal.data.themeId === theme.id ? 'ring-4 ring-primary-brand ring-offset-4 scale-110' : 'opacity-40']"><i :data-lucide="theme.icon" class="w-7 h-7 text-center"></i></div>
                        </div>
                    </div>
                    <div class="space-y-4 text-left text-left text-left"><div class="flex justify-between items-center px-1 text-left text-left text-left text-left"><label class="text-sm font-black text-accent-purple/60 uppercase text-left text-left">每週排程</label><button @click.stop="selectWorkdays" class="text-xs font-black text-primary-brand bg-primary-brand/10 px-4 py-1.5 rounded-full active:scale-95 text-center text-center text-center">工作日模式</button></div><div class="grid grid-cols-7 gap-2 text-center text-center text-center text-center text-center"><button v-for="(label, index) in weekLabelsShort" :key="index" @click.stop="toggleDayInModal(index)" :class="['h-11 rounded-xl font-black text-sm border-2 transition-all text-center', habitModal.data.selectedDays.includes(index) ? 'bg-primary-brand border-primary-brand text-white' : 'bg-gray-50 border-transparent text-gray-300 text-center']">{{ label }}</button></div></div>
                </div>
            </div>
            <div class="p-6 bg-white/80 backdrop-blur-md border-t border-gray-100 flex gap-4 rounded-b-[24px] text-center text-center text-center"><button @click="habitModal.show = false" class="flex-1 h-14 bg-gray-100 rounded-[16px] font-black text-gray-400 text-lg active:scale-95 text-center text-center">取消</button><button @click="saveHabit" class="flex-1 h-14 bg-primary-brand rounded-[16px] font-black text-white text-lg shadow-dreamy active:scale-95 text-center text-center">{{ habitModal.isEdit ? '儲存修改' : '確認建立' }}</button></div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        const weekLabelsShort = ['日', '一', '二', '三', '四', '五', '六'];
        const tabTitlesShort = { home: 'HabitDuo', habits: '我的習慣列表', stats: '統計數據' };
        const tabIcons = { home: 'home', habits: 'layers', stats: 'line-chart' };
        const suggestionHabits = ['每日喝水', '睡前閱讀', '正念冥想', '早起運動', '補充維命', '心情日記'];
        
        const themeLibrary = [
            { id: 'health', color: 'bg-success-mint', icon: 'zap', keywords: ['跑','運','健','泳','瑜','散'] },
            { id: 'wisdom', color: 'bg-primary-brand', icon: 'book', keywords: ['讀','學','寫','知','閱','英'] },
            { id: 'daily', color: 'bg-[#60A5FA]', icon: 'droplet', keywords: ['水','咖','飲','果','維'] },
            { id: 'peace', color: 'bg-streak-coral', icon: 'heart', keywords: ['心','冥','放','睡','感','聽'] },
            { id: 'star', color: 'bg-gold-shine', icon: 'star', keywords: ['目','計','成','存','挑'] }
        ];

        const habits = ref(JSON.parse(localStorage.getItem('habits')) || []);
        const checkins = ref(JSON.parse(localStorage.getItem('checkins')) || {}); 
        const statsFilter = ref('seven');

        const totalCheckinCount = computed(() => {
            let total = 0;
            Object.values(checkins.value).forEach(v => { 
                Object.values(v).forEach(l => { if(l.done) total++; });
            });
            return total;
        });

        const birdLevel = computed(() => totalCheckinCount.value >= 50 ? 2 : totalCheckinCount.value >= 10 ? 1 : 0);
        const evolutionRequirement = computed(() => birdLevel.value === 0 ? 10 : birdLevel.value === 1 ? 50 : 100);

        const activeTab = ref('home');
        const selectedDate = ref(new Date());
        const weekPivotDate = ref(new Date()); 
        const statsViewDate = ref(new Date()); 
        const isHistoryMonthView = ref(false);
        const habitModal = ref({ show: false, isEdit: false, data: {} });
        const logModal = ref({ show: false, habit: null, note: '' });
        const swipedId = ref(null);
        const isAnimating = ref(false); 
        const confettiList = ref([]);
        const habitErrors = ref({ name: false });
        let touchStartX = 0;

        const getFormattedDate = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };
        const isSameDay = (d1, d2) => getFormattedDate(d1) === getFormattedDate(d2);
        const isChecked = (id) => checkins.value[getFormattedDate(selectedDate.value)]?.[id]?.done || false;
        const hasLog = (date) => checkins.value[getFormattedDate(date)] && Object.values(checkins.value[getFormattedDate(date)]).some(l => l.done);
        const getMood = (id) => checkins.value[getFormattedDate(selectedDate.value)]?.[id]?.note || '';
        
        const mascotGreeting = computed(() => isAnimating.value ? "注入能量成功！" : (birdLevel.value === 0 ? "嘿，快來孵化我吧！" : "今天的目標也要達成喔！"));

        const habitsForSelectedDay = computed(() => {
            const dayIdx = selectedDate.value.getDay();
            return habits.value.filter(h => h.selectedDays.includes(dayIdx) && h.isActive !== false);
        });

        const dayDoneCount = computed(() => habitsForSelectedDay.value.filter(h => isChecked(h.id)).length);

        const filteredWeeklyData = computed(() => {
            const data = []; const now = new Date();
            let numWeeks = statsFilter.value === 'month' ? 4 : statsFilter.value === 'all' ? 12 : 7;
            for (let i = numWeeks - 1; i >= 0; i--) {
                const wEnd = new Date(now); wEnd.setDate(now.getDate() - (i * 7));
                const wStart = new Date(wEnd); wStart.setDate(wEnd.getDate() - 6);
                let count = 0; let possible = 0;
                for (let d = 0; d < 7; d++) {
                    const curr = new Date(wStart); curr.setDate(wStart.getDate() + d);
                    const ds = getFormattedDate(curr); const dow = curr.getDay();
                    habits.value.forEach(h => { if (h.selectedDays.includes(dow) && h.isActive !== false) { possible++; if (checkins.value[ds]?.[h.id]?.done) count++; }});
                }
                data.push({ label: i === 0 ? '本週' : `${i}w`, rate: possible > 0 ? (count / possible) * 100 : 0 });
            }
            return data;
        });

        const monthlyRanking = computed(() => {
            const now = new Date();
            return habits.value.map(h => {
                let count = 0;
                Object.entries(checkins.value).forEach(([ds, logs]) => {
                    const d = new Date(ds);
                    if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear() && logs[h.id]?.done) count++;
                });
                return { ...h, count };
            }).filter(h => h.count > 0).sort((a,b) => b.count - a.count);
        });

        const openHabitModal = (habit = null) => {
            swipedId.value = null; habitErrors.value.name = false;
            if (habit) habitModal.value = { show: true, isEdit: true, data: JSON.parse(JSON.stringify(habit)) };
            else habitModal.value = { show: true, isEdit: false, data: { name: '', selectedDays: [0,1,2,3,4,5,6], themeId: 'wisdom', color: 'bg-primary-brand', icon: 'book', createdAt: Date.now(), isActive: true } };
            nextTick(() => { if (window.lucide) lucide.createIcons(); });
        };

        const saveHabit = () => {
            if(!habitModal.value.data.name){ habitErrors.value.name = true; return; }
            if(habitModal.value.isEdit){
                const idx = habits.value.findIndex(h => h.id === habitModal.value.data.id);
                if(idx !== -1) habits.value[idx] = habitModal.value.data;
            } else {
                habits.value.push({ ...habitModal.value.data, id: Date.now() });
            }
            habitModal.value.show = false;
        };

        const handleSmartHint = () => {
            const n = habitModal.value.data.name; if(!n) return; habitErrors.value.name=false;
            const found = themeLibrary.find(t => t.keywords?.some(k => n.includes(k)));
            if(found){ habitModal.value.data.themeId=found.id; habitModal.value.data.color=found.color; habitModal.value.data.icon=found.icon; }
            nextTick(() => { if (window.lucide) lucide.createIcons(); });
        };

        const selectSuggestion = (n) => {
            habitModal.value.data.name = n;
            handleSmartHint();
        };

        const handleCheckinFeedback = (habit, event) => {
            const ds = getFormattedDate(selectedDate.value);
            if(!checkins.value[ds]) checkins.value[ds] = {};
            if(!checkins.value[ds][habit.id]) checkins.value[ds][habit.id] = {done:false, note:''};
            const current = checkins.value[ds][habit.id].done;
            checkins.value[ds][habit.id].done = !current;
            if(!current){
                const colors = ['#A78BFA', '#6EE7B7', '#FDA4AF', '#FFFFFF', '#FBBF24'];
                for (let i = 0; i < 30; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.random() * 150 + 50;
                    confettiList.value.push({
                        id: Math.random(), originX: event.clientX, originY: event.clientY,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        size: Math.random() * 8 + 4, tx: Math.cos(angle) * dist, ty: Math.sin(angle) * dist - 50, rot: Math.random() * 360
                    });
                }
                setTimeout(() => { confettiList.value = confettiList.value.slice(30); }, 2000);
                if(isSameDay(new Date(), selectedDate.value)) { isAnimating.value = true; setTimeout(() => isAnimating.value = false, 600); }
                logModal.value = { show: true, habit: habit, note: checkins.value[ds][habit.id].note || '' };
            }
        };

        const saveCheckinLog = () => {
            const ds = getFormattedDate(selectedDate.value);
            if(logModal.value.habit?.id) {
                if(!checkins.value[ds]) checkins.value[ds] = {};
                checkins.value[ds][logModal.value.habit.id] = { done: true, note: logModal.value.note };
            }
            logModal.value.show = false;
        };

        onMounted(() => { if (window.lucide) lucide.createIcons(); });
        watch([activeTab, habits, checkins, selectedDate, isHistoryMonthView], () => { 
            nextTick(() => { if (window.lucide) lucide.createIcons(); }); 
            localStorage.setItem('habits', JSON.stringify(habits.value));
            localStorage.setItem('checkins', JSON.stringify(checkins.value));
        }, { deep: true });

        return {
            activeTab, habits, checkins, selectedDate, weekPivotDate, habitModal, logModal, swipedId, isAnimating, confettiList, habitErrors, statsViewDate, isHistoryMonthView, statsFilter,
            tabTitlesShort, tabIcons, statsMonthLabel: computed(() => `${statsViewDate.value.getMonth() + 1}月`),
            themeLibrary, suggestionHabits, birdLevel, mascotGreeting, totalCheckinCount,
            topStats: computed(() => [{ label: '項目數', value: habits.value.length }, { label: '紀錄天', value: Object.keys(checkins.value).length }, { label: '總打卡', value: totalCheckinCount.value }, { label: '月完成', value: monthlyRanking.value.length }]),
            evolutionRequirement, isSameDay, hasLog, isChecked, getMood, dayDoneCount, filteredWeeklyData, monthlyRanking,
            habitsForSelectedDay, weekLabelsShort,
            sortedHabits: computed(() => [...habits.value].sort((a,b) => b.createdAt - a.createdAt)),
            changeWeek: (dir) => { weekPivotDate.value = new Date(weekPivotDate.value.setDate(weekPivotDate.value.getDate() + dir*7)); },
            calendarDays: computed(() => {
                const year = statsViewDate.value.getFullYear(); const month = statsViewDate.value.getMonth();
                const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
                const days = []; const prevMonthDays = new Date(year, month, 0).getDate();
                for (let i = firstDay - 1; i >= 0; i--) { days.push({ date: new Date(year, month - 1, prevMonthDays - i), currentMonth: false }); }
                for (let i = 1; i <= daysInMonth; i++) { days.push({ date: new Date(year, month, i), currentMonth: true }); }
                const remaining = 42 - days.length;
                for (let i = 1; i <= remaining; i++) { days.push({ date: new Date(year, month + 1, i), currentMonth: false }); }
                return days;
            }),
            toggleCalendarView: () => { isHistoryMonthView.value = !isHistoryMonthView.value; },
            changeMonth: (dir) => { statsViewDate.value = new Date(statsViewDate.value.setMonth(statsViewDate.value.getMonth() + dir)); },
            saveHabit, openHabitModal, handleSmartHint, selectSuggestion, handleCheckinFeedback, saveCheckinLog,
            applyTheme: (theme) => { habitModal.value.data.themeId = theme.id; habitModal.value.data.color = theme.color; habitModal.value.data.icon = theme.icon; nextTick(() => { if (window.lucide) lucide.createIcons(); }); },
            selectWorkdays: () => { habitModal.value.data.selectedDays = [1,2,3,4,5]; },
            toggleDayInModal: (i) => {
                const idx = habitModal.value.data.selectedDays.indexOf(i);
                if(idx > -1){ if(habitModal.value.data.selectedDays.length > 1) habitModal.value.data.selectedDays.splice(idx,1);}
                else{habitModal.value.data.selectedDays.push(i);habitModal.value.data.selectedDays.sort();}
            },
            toggleHabitActive: (habit) => { habit.isActive = !habit.isActive; },
            deleteHabit: (id) => { if(confirm('取消此計畫？')){ habits.value = habits.value.filter(x=>x.id!==id); } },
            handleTouchStart: (e, id) => { touchStartX = e.touches[0].clientX; },
            handleTouchEnd: (e, id) => { const diff = touchStartX - e.changedTouches[0].clientX; if (diff > 50) swipedId.value = id; else if (diff < -50) swipedId.value = null; },
            getMonthlyDoneCount: (id) => Object.entries(checkins.value).filter(([ds, logs]) => new Date(ds).getMonth() === new Date().getMonth() && logs[id]?.done).length,
            getHabitStreak: (id) => {
                let streak = 0; let curr = new Date();
                const check = (d) => checkins.value[getFormattedDate(d)]?.[id]?.done || false;
                while (check(curr)) { streak++; curr.setDate(curr.getDate() - 1); }
                return streak;
            },
            formatDateSimpleShort: (ts) => `${new Date(ts).getMonth()+1}/${new Date(ts).getDate()}`,
            weekDays: computed(() => {
                const res = []; const curr = new Date(weekPivotDate.value); const first = curr.getDate() - curr.getDay();
                for(let i=0; i<7; i++){ const d = new Date(weekPivotDate.value); d.setDate(first+i); res.push({date:d, dayNum:d.getDate(), label:weekLabelsShort[i]}); }
                return res;
            })
        };
    }
}).mount('#app');
</script>

</body>
</html>
